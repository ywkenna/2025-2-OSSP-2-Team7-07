<script>
    const API_BASE = "http://127.0.0.1:8000";

    const saveBtn = document.getElementById("save-score-btn");
    const editBtn = document.getElementById("edit-score-btn");
    const inputSection = document.getElementById("score-input-section");
    const resultSection = document.getElementById("score-result-section");

    async function saveScoreToServer() {
        const type = document.getElementById("test-type").value;
        const score = document.getElementById("test-score").value;
        const level = convert_to_cefr(type, score)
        const access = localStorage.getItem("access");

        const res = await fetch(`${API_BASE}/api/users/userinfo/`, {
            method: "PATCH",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${access}`
            },
            body: JSON.stringify({ english_level: level })
        });

        const data = await res.json();

        if (data.english_level !== undefined) {
            document.getElementById("saved-test").textContent = type.toUpperCase();
            document.getElementById("saved-score").textContent = score;
            document.getElementById("saved-level").textContent =
                ["A1","A2","B1","B2","C1","C2"][data.level];

            inputSection.style.display = "none";
            resultSection.style.display = "block";
        }
    }

    saveBtn.addEventListener("click", saveScoreToServer);

    editBtn.addEventListener("click", ()=> {
        inputSection.style.display = "block";
        resultSection.style.display = "none";
    });

    async function loadScoreFromDB() {
        const access = localStorage.getItem("access");

        const res = await fetch(`${API_BASE}/api/users/userinfo/`, {
            headers: { "Authorization": `Bearer ${access}` }
        });

        const data = await res.json();
        const level = data.english_level;

        if (level === null || level === undefined) {
            inputSection.style.display = "block";
            resultSection.style.display = "none";
            return;
        }

        document.getElementById("saved-level").textContent =
            ["A1","A2","B1","B2","C1","C2"][level];
        document.getElementById("saved-test").textContent = "";
        document.getElementById("saved-score").textContent = "";

        inputSection.style.display = "none";
        resultSection.style.display = "block";
    }

    function convert_to_cefr(type, score) {
        if (type == "toeic") {
            if (score >= 945) return 5
            if (score >= 785) return 4
            if (score >= 550) return 3
            if (score >= 225) return 2
            return 1
        }

        if (type == "toefl") {
            if (score >= 95) return 5
            if (score >= 72) return 4
            if (score >= 42) return 3
            return 2
        }

        if (type == "ielts") {
            if (score > 8.0) return 5
            if (score >= 7.0) return 4
            if (score >= 5.5) return 3
            if (score >= 4.0) return 2
            if (score >= 2.5) return 1
            return 0
        }

        return 0
    }

    loadScoreFromDB();
</script>
