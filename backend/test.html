<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>회원가입 / 로그인 테스트</title>
</head>
<body>

<div class="container">
    <h2>회원가입</h2>
    <form id="registerForm" onsubmit="register(event)">

        <label>이름*</label>
        <input type="text" name="first_name" required /><br/>

        <label>아이디*</label>
        <input type="text" name="username" required /><br/>

        <label>비밀번호*</label>
        <input type="password" name="password" required /><br/>

        <label>이메일</label>
        <input type="email" name="email" /><br/>

        <label>영어레벨</label>
        <input type="number" name="english_level" /><br/>

        <button type="submit">회원가입</button>
    </form>

    <h2 id="loginTitle">로그인</h2>
    <form id="loginForm" onsubmit="login(event)">
        <label>아이디</label>
        <input type="text" name="username" required /><br/>

        <label>비밀번호</label>
        <input type="password" name="password" required /><br/>

        <button type="submit">로그인</button>
    </form>

    <div id="userBox" class="hidden">
        <h2>사용자 정보</h2>
        <div class="userinfo" id="userInfo"></div>
    </div>
</div>

<script>
const API = "http://localhost:8000/api/users";

// 회원가입
async function register(e) {
    e.preventDefault();
    const form = e.target;
    const body = {
        username: form.username.value,
        password: form.password.value,
        first_name: form.first_name.value,
        email: form.email.value,
        english_level: form.english_level.value === "" ? null : Number(form.english_level.value)
    };

    const res = await fetch(`${API}/register/`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
    });

    if (res.ok) {
        alert("회원가입 성공");
        form.reset();
    } else {
    const data = await res.json();
    console.log(data);

    const firstKey = Object.keys(data)[0];
    const message = data[firstKey][0];

    alert(`회원가입 실패: ${message}`);
    }
}


// 로그인
async function login(e) {
    e.preventDefault();
    const form = e.target;
    const body = {
        username: form.username.value,
        password: form.password.value,
    };

    const res = await fetch(`${API}/login/`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
    });

    const data = await res.json();

    if (res.ok) {
        localStorage.setItem("access", data.access);
        localStorage.setItem("refresh", data.refresh);
        alert("로그인 성공");
        form.reset();
        loadUserInfo();
    } else {
        alert("로그인 실패");
    }
}

// 로그아웃
async function logout() {
    alert("로그아웃 성공");
    localStorage.removeItem("access");
    localStorage.removeItem("refresh");
    document.getElementById("userInfo").innerHTML = ``;

    /* 
    const access = localStorage.getItem("access");
    if (!access) {
        return;
    }

    const res = await fetch(`${API}/logout/`, {
        method: "POST",
        headers: { 
            "Authorization": `Bearer ${access}`
        }
    });

    if(res.ok) {        
        alert("로그아웃 성공");
        localStorage.removeItem("access");
        localStorage.removeItem("refresh");
    
        document.getElementById("userInfo").innerHTML = ``;
    } else {
        alert("로그아웃 에러");
    } 
    */
}

// 로그인 상태 확인 후 정보 표시
async function loadUserInfo() {
    const access = localStorage.getItem("access");
    if (!access) {
        return;
    }

    const res = await fetch(`${API}/userinfo/`, {
        headers: { "Authorization": `Bearer ${access}` }
    });

    if (!res.ok) {
        return;
    }

    const userdata = await res.json();

    document.getElementById("userInfo").innerHTML = `
        아이디: ${userdata.username}<br/>
        이름: ${userdata.first_name}<br/>
        Email: ${userdata.email}<br/>
        영어레벨: ${userdata.english_level}<br/>
        <input id="updateLevelInput" type="number" />
        <button onclick="updateLevel()">수정</button><br/>
        <button onclick="logout()">로그아웃</button>
    `;
}

async function updateLevel() {
    const access = localStorage.getItem("access");
    const newLevel = Number(document.getElementById("updateLevelInput").value);

    const res = await fetch(`${API}/userinfo/`, {
        method: "PATCH",
        headers: { 
            "Content-Type": "application/json",
            "Authorization": `Bearer ${access}`
        },
        body: JSON.stringify({ english_level: newLevel })
    });

    if (res.ok) {
        alert("영어레벨 수정 성공");
        loadUserInfo();
    }
}

async function likeMovie(movieId) {
    const res = await fetch(`${API}/like/${movieId}/`, {
        method: "POST",
        headers: {
            "Authorization": "Bearer " + localStorage.getItem("access"),
            "Content-Type": "application/json"
        }
    })

    if(res.ok) {
        alert("영화 찜 성공");
    }
}

async function unlikeMovie(movieId) {
    const res = await fetch(`${API}/like/${movieId}/`, {
        method: "DELETE",
        headers: {
            "Authorization": "Bearer " + localStorage.getItem("access"),
            "Content-Type": "application/json"
        }
    })

    if(res.ok) {
        alert("영화 찜 취소 성공");
    }
}

async function getLikedMovies() {
    const res = await fetch(`${API}/like/`, {
        method: "GET",
        headers: {
            "Authorization": "Bearer " + localStorage.getItem("access")
        }
    })
    if(res.ok) {
        const data = res.json();
        return data;
    }
}

// 페이지가 로드되면 로그인 상태 확인
loadUserInfo();
</script>

</body>
</html>